



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="README, Getting Started, Documentation, and Release Notes for OpenFn">
      
      
        <link rel="canonical" href="https://openfn.github.io/docs/core.html">
      
      
        <meta name="author" content="OpenFn">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.2">
    
    
      
        <title>Job Execution - OpenFn Documentation</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/application.982221ab.css">
      
        <link rel="stylesheet" href="assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#03a9f4">
      
    
    
      <script src="assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-57118569-4", "openfn.org")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="light-blue" data-md-color-accent="deep-purple">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#job-execution" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://openfn.github.io/docs" title="OpenFn Documentation" class="md-header-nav__button md-logo">
          
            <img src="images/logo.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              OpenFn Documentation
            </span>
            <span class="md-header-nav__topic">
              Job Execution
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/openfn/docs/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://openfn.github.io/docs" title="OpenFn Documentation" class="md-nav__button md-logo">
      
        <img src="images/logo.svg" width="48" height="48">
      
    </a>
    OpenFn Documentation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/openfn/docs/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="index.html" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="quick-start.html" title="Quick Start" class="md-nav__link">
      Quick Start
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="faqs.html" title="FAQs" class="md-nav__link">
      FAQs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="about.html" title="About us" class="md-nav__link">
      About us
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      The OpenFn.org Platform
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        The OpenFn.org Platform
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="documentation.html" title="Basic Documentation" class="md-nav__link">
      Basic Documentation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="trouble-shooting.html" title="Troubleshooting Data Errors" class="md-nav__link">
      Troubleshooting Data Errors
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="appendix.html" title="Snippets & Sample Code" class="md-nav__link">
      Snippets & Sample Code
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="release-notes.html" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="diy.html" title="DIY" class="md-nav__link">
      DIY
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      Writing Jobs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Writing Jobs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Job Execution
      </label>
    
    <a href="core.html" title="Job Execution" class="md-nav__link md-nav__link--active">
      Job Execution
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" title="Introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-terms-and-concepts" title="Key Terms and Concepts" class="md-nav__link">
    Key Terms and Concepts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#state-is-passed-to-operations-operations-return-state" title="State is passed to operations. Operations Return state." class="md-nav__link">
    State is passed to operations. Operations Return state.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sequences-of-operations-inside-custom-functions" title="Sequences of operations inside custom functions." class="md-nav__link">
    Sequences of operations inside custom functions.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controlling-timing-between-operations-with-async-functions" title="Controlling timing between operations with async functions." class="md-nav__link">
    Controlling timing between operations with async functions.
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="job-library.html" title="The Job Library" class="md-nav__link">
      The Job Library
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Connecting Data Sources
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Connecting Data Sources
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="source-apps.html" title="Source Apps" class="md-nav__link">
      Source Apps
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="for-devs.html" title="Application Developers" class="md-nav__link">
      Application Developers
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" title="Introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-terms-and-concepts" title="Key Terms and Concepts" class="md-nav__link">
    Key Terms and Concepts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#state-is-passed-to-operations-operations-return-state" title="State is passed to operations. Operations Return state." class="md-nav__link">
    State is passed to operations. Operations Return state.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sequences-of-operations-inside-custom-functions" title="Sequences of operations inside custom functions." class="md-nav__link">
    Sequences of operations inside custom functions.
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#controlling-timing-between-operations-with-async-functions" title="Controlling timing between operations with async functions." class="md-nav__link">
    Controlling timing between operations with async functions.
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/openfn/docs/edit/master/docs/core.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="job-execution">Job Execution<a class="headerlink" href="#job-execution" title="Permanent link">#</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">#</a></h2>
<p>This is technical documentation aimed at making complex custom jobs easier to
write.</p>
<h2 id="key-terms-and-concepts">Key Terms and Concepts<a class="headerlink" href="#key-terms-and-concepts" title="Permanent link">#</a></h2>
<ol>
<li><strong>core</strong> (https://github.com/openfn/core) is the Javascript program which
   executes jobs for OpenFn in an emphemeral Node.js environment.</li>
<li><strong>state</strong> is a .JSON file that is built and passed into the Node environment.
   It contains at least two keys, <code>configuration</code> and <code>data</code>. Configuration will
   be populated with your credential and it used by language packages for
   authentication, and data will be populated with message data if the job was
   triggered by an incoming message.</li>
</ol>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;configuration&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;taylor&quot;</span><span class="p">,</span>
    <span class="nt">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;shhhhhh&quot;</span><span class="p">,</span>
    <span class="nt">&quot;loginUrl&quot;</span><span class="p">:</span> <span class="s2">&quot;https://login.salesforce.com&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nt">&quot;b&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;x&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<ol>
<li><strong>expressions</strong> are sequences of operations to be executed. They are part of
   "jobs", which also include a credential, a trigger, a label, and (sometimes)
   a github filepath.</li>
<li><strong>operations</strong> are named functions, exported for use by specific
   language-packages, which take state and return state.</li>
</ol>
<h2 id="state-is-passed-to-operations-operations-return-state">State is passed to operations. Operations Return state.<a class="headerlink" href="#state-is-passed-to-operations-operations-return-state" title="Permanent link">#</a></h2>
<p>This is a key concept. When you write:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">create</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="nx">fields</span><span class="p">(</span>
  <span class="nx">field</span><span class="p">(...)</span>
<span class="p">));</span>
</pre></div>
</td></tr></table>

<p>The execute function in your language-package (e.g., <code>language-salesforce</code>) will
execute each operation with state, then return state. If you want to execute
operations inside another custom function, you must explicitly pass in state.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">alterState</span><span class="p">(</span><span class="nx">state</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">create</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="nx">fields</span><span class="p">(</span>
    <span class="nx">field</span><span class="p">(...)</span>
  <span class="p">))(</span><span class="nx">state</span><span class="p">)</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h2 id="sequences-of-operations-inside-custom-functions">Sequences of operations inside custom functions.<a class="headerlink" href="#sequences-of-operations-inside-custom-functions" title="Permanent link">#</a></h2>
<p>Using <code>execute</code> you can string together several sequential operations inside a
custom function.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">alterState</span><span class="p">(</span><span class="nx">state</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">userName</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">meta</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">userName</span> <span class="o">!=</span> <span class="s1">&#39;tester&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">execute</span><span class="p">(</span>
      <span class="nx">upsert</span><span class="p">(</span><span class="s2">&quot;person__c&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="nx">fields</span><span class="p">(</span>
        <span class="nx">field</span><span class="p">(...),</span>
        <span class="nx">field</span><span class="p">(...)</span>
      <span class="p">)),</span>
      <span class="nx">beta</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span>
        <span class="nx">dataPath</span><span class="p">(</span><span class="s2">&quot;form.array[*]&quot;</span><span class="p">),</span>
        <span class="nx">upsert</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="nx">fields</span><span class="p">(</span>
          <span class="nx">field</span><span class="p">(...)</span>
        <span class="p">))</span>
      <span class="p">)</span>
    <span class="p">)(</span><span class="nx">state</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h2 id="controlling-timing-between-operations-with-async-functions">Controlling timing between operations with async functions.<a class="headerlink" href="#controlling-timing-between-operations-with-async-functions" title="Permanent link">#</a></h2>
<p>To get really complex, you might want to execute a number of async functions
inside an <code>alterState</code> operation, but WAIT for those functions to resolve before
moving on to your next operation. If <code>execute</code> doesn't work for your use case,
you could use <code>Promise.all</code> and return an async function.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">alterState</span><span class="p">(</span><span class="nx">state</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Here we will await the result of a LOT of async operations.&#39;</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;First we define a bunch of different async functions.&#39;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">postClinics</span> <span class="o">=</span> <span class="nx">async</span> <span class="nx">c</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">post</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">configuration</span><span class="p">.</span><span class="nx">inboxUrl</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">body</span><span class="o">:</span> <span class="p">{</span> <span class="nx">clinics</span><span class="o">:</span> <span class="nx">c</span> <span class="p">},</span>
    <span class="p">})(</span><span class="nx">state</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">postPatients</span> <span class="o">=</span> <span class="nx">async</span> <span class="nx">p</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">post</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">configuration</span><span class="p">.</span><span class="nx">inboxUrl</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">body</span><span class="o">:</span> <span class="p">{</span> <span class="nx">patients</span><span class="o">:</span> <span class="nx">p</span> <span class="p">},</span>
    <span class="p">})(</span><span class="nx">state</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kr">const</span> <span class="nx">postVisits</span> <span class="o">=</span> <span class="nx">async</span> <span class="nx">v</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">post</span><span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">configuration</span><span class="p">.</span><span class="nx">inboxUrl</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">body</span><span class="o">:</span> <span class="p">{</span> <span class="nx">visits</span><span class="o">:</span> <span class="nx">v</span> <span class="p">},</span>
    <span class="p">})(</span><span class="nx">state</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
    <span class="s1">&#39;Then we define a single function that wraps them all up and waits for all the individual functions to resolve.&#39;</span>
  <span class="p">);</span>
  <span class="nx">async</span> <span class="kd">function</span> <span class="nx">makePosts</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
      <span class="p">...</span><span class="nx">state</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">clinicSets</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span> <span class="p">=&gt;</span> <span class="nx">postClinics</span><span class="p">(</span><span class="nx">item</span><span class="p">)),</span>
      <span class="p">...</span><span class="nx">state</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">patientSets</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span> <span class="p">=&gt;</span> <span class="nx">postPatients</span><span class="p">(</span><span class="nx">item</span><span class="p">)),</span>
      <span class="p">...</span><span class="nx">state</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">visitSets</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span> <span class="p">=&gt;</span> <span class="nx">postVisits</span><span class="p">(</span><span class="nx">item</span><span class="p">)),</span>
    <span class="p">]);</span>
  <span class="p">}</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
    <span class="s1">&#39;Then we return that function, forcing our next operation to await the result of this one.&#39;</span>
  <span class="p">);</span>
  <span class="k">return</span> <span class="nx">makePosts</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">alterState</span><span class="p">(</span><span class="nx">state</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;I get called AFTER those async functions are resolved.&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">state</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="diy.html" title="DIY" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                DIY
              </span>
            </div>
          </a>
        
        
          <a href="job-library.html" title="The Job Library" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                The Job Library
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright (c) 2019 Open Function Group LLC
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="assets/fonts/font-awesome.css">
    
      <a href="https://github.com/openfn" class="md-footer-social__link fa fa-"></a>
    
      <a href="https://facebook.com/openfn" class="md-footer-social__link fa fa-"></a>
    
      <a href="https://twitter.com/openfn" class="md-footer-social__link fa fa-"></a>
    
      <a href="https://linkedin.com/in/openfn" class="md-footer-social__link fa fa-"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/application.d9aa80ab.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"."}})</script>
      
        <script src="freshChat.js"></script>
      
    
  </body>
</html>