<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="OpenFn Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="OpenFn Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-57118569-4","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="alternate" type="application/rss+xml" href="/articles/rss.xml" title="OpenFn Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/articles/atom.xml" title="OpenFn Blog Atom Feed">
<script src="./freshChat.js" async></script><title data-react-helmet="true">Snippets &amp; Sample Code | OpenFn</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Snippets &amp; Sample Code | OpenFn"><meta data-react-helmet="true" name="description" content="Filters"><meta data-react-helmet="true" property="og:description" content="Filters"><meta data-react-helmet="true" property="og:url" content="https://docs.openfn.org/documentation/appendix"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.openfn.org/documentation/appendix"><link rel="stylesheet" href="/styles.88553f97.css">
<link rel="preload" href="/styles.0cd493b1.js" as="script">
<link rel="preload" href="/runtime~main.995dbd0d.js" as="script">
<link rel="preload" href="/main.1ef3c80f.js" as="script">
<link rel="preload" href="/1.5843ccaf.js" as="script">
<link rel="preload" href="/2.fd2ee5c5.js" as="script">
<link rel="preload" href="/01a85c17.a7feb7ed.js" as="script">
<link rel="preload" href="/1be78505.2552ac6d.js" as="script">
<link rel="preload" href="/6875c492.f6c16a7d.js" as="script">
<link rel="preload" href="/a6aa9e1f.c0f6bc6b.js" as="script">
<link rel="preload" href="/c4f5d8e4.cbd158d4.js" as="script">
<link rel="preload" href="/ccc49370.e4d7dd25.js" as="script">
<link rel="preload" href="/78.474ff80a.js" as="script">
<link rel="preload" href="/77.c7ff769e.js" as="script">
<link rel="preload" href="/935f2afb.1e7c041b.js" as="script">
<link rel="preload" href="/17896441.f9ac7cb1.js" as="script">
<link rel="preload" href="/cddf45a4.a57beaf6.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="OpenFn" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="OpenFn" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">OpenFn/docs</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/documentation/">Docs</a><a class="navbar__item navbar__link" href="/library">Library</a><a class="navbar__item navbar__link" href="/articles">Articles</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/openfn/docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar" style="outline:none"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="OpenFn" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/img/logo.svg" alt="OpenFn" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">OpenFn/docs</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/documentation/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/library">Library</a></li><li class="menu__list-item"><a class="menu__link" href="/articles">Articles</a></li><li class="menu__list-item"><a href="https://github.com/openfn/docs" target="_blank" rel="noopener noreferrer" class="menu__link header-github-link" aria-label="GitHub repository"></a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/documentation/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" href="/documentation/quick-start">Quick-start</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Integration Platform</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/documentation/platform">Platform Docs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/documentation/trouble-shooting">Troubleshooting</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/documentation/appendix">Snippets &amp; Sample Code</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/documentation/release-notes">Release Notes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/documentation/diy">Off-Platform (DIY)</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Connecting Apps</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/documentation/source-apps">Connecting Data Sources</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/documentation/tools/commcare">CommCare HQ</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/documentation/tools/godata">Go.Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/documentation/tools/kobo-toolbox">Kobo Toolbox</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/documentation/for-devs">For Application Developers</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Writing Jobs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/documentation/jobs/core">Understanding Jobs</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/documentation/jobs/operations">What&#x27;s an operation?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/documentation/jobs/multiple-operations">Using multiple operations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/documentation/jobs/errors">Exit Codes &amp; Errors</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/library">The Library</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/documentation/faqs">FAQs</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Writing Docs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/documentation/style-guide">Style Guide</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/documentation/about">About</a></li><li class="menu__list-item"><a href="https://community.openfn.org" target="_blank" rel="noreferrer noopener" class="menu__link">Community Forum</a></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Snippets &amp; Sample Code</h1></header><div class="markdown"><h2 id="filters">Filters</h2><h3 id="match-messages-where-the-formid-is-robot_photo_21042015">Match messages <code>WHERE</code> the <code>formId</code> is <code>&quot;Robot_Photo_21.04.2015&quot;</code></h3><pre><code class="language-json">{ &quot;formId&quot;: &quot;Robot_Photo_21.04.2015&quot; }
</code></pre><h3 id="match-a-message-where-this-and-that-are-both-included">Match a message <code>WHERE</code> this <code>AND</code> that are both included</h3><pre><code class="language-json">{ &quot;formId&quot;: &quot;Robot_Photo_21.04.2015&quot;, &quot;secret_number&quot;: 8 }
</code></pre><h3 id="match-a-message-with-two-fragments-inside-an-array-called-data">Match a message with two fragments inside an array called <code>data</code></h3><p>(This is useful when gathering data via ODK)</p><pre><code class="language-json">{ &quot;data&quot;: [{ &quot;outlet_call&quot;: &quot;TRUE&quot;, &quot;new_existing&quot;: &quot;Existing&quot; }] }
</code></pre><h3 id="match-a-message-with-a-fragment-inside-another-object-called-form">Match a message with a fragment inside another object called <code>form</code></h3><pre><code class="language-json">{
  &quot;form&quot;: {
    &quot;@xmlns&quot;: &quot;http://openrosa.org/formdesigner/F732194-3278-nota-ReAL-one&quot;
  }
}
</code></pre><h2 id="job-expressions">Job Expressions</h2><p>Below you can find some examples of block code for different functions and data
handling contexts.</p><h3 id="job-expression-for-commcare-to-sf">Job expression (for CommCare to SF)</h3><p>The following job expression will take a matching receipt and use data from that
receipt to upsert a <code>Patient__c</code> record in Salesforce and create multiple new
<code>Patient_Visit__c</code> (child to Patient) records.</p><pre><code class="language-js">upsert(
  &#x27;Patient__c&#x27;,
  &#x27;Patient_Id__c&#x27;,
  fields(
    field(&#x27;Patient_Id__c&#x27;, dataValue(&#x27;form.patient_ID&#x27;)),
    relationship(&#x27;Nurse__r&#x27;, &#x27;Nurse_ID_code__c&#x27;, dataValue(&#x27;form.staff_id&#x27;)),
    field(&#x27;Phone_Number__c&#x27;, dataValue(&#x27;form.mobile_phone&#x27;))
  )
),
  each(
    join(&#x27;$.data.form.visits[*]&#x27;, &#x27;$.references[0].id&#x27;, &#x27;Id&#x27;),
    create(
      &#x27;Visit__c&#x27;,
      fields(
        field(&#x27;Patient__c&#x27;, dataValue(&#x27;Id&#x27;)),
        field(&#x27;Date__c&#x27;, dataValue(&#x27;date&#x27;)),
        field(&#x27;Reason__c&#x27;, dataValue(&#x27;why_did_they_see_doctor&#x27;))
      )
    )
  );
</code></pre><h3 id="accessing-the-data-array-in-open-data-kit-submissions">Accessing the &quot;data array&quot; in Open Data Kit submissions</h3><p>Notice how we use &quot;each&quot; to get data from each item inside the &quot;data array&quot; in
ODK.</p><pre><code class="language-js">each(
  &#x27;$.data.data[*]&#x27;,
  create(
    &#x27;ODK_Submission__c&#x27;,
    fields(
      field(&#x27;Site_School_ID_Number__c&#x27;, dataValue(&#x27;school&#x27;)),
      field(&#x27;Date_Completed__c&#x27;, dataValue(&#x27;date&#x27;)),
      field(&#x27;comments__c&#x27;, dataValue(&#x27;comments&#x27;)),
      field(&#x27;ODK_Key__c&#x27;, dataValue(&#x27;*meta-instance-id*&#x27;))
    )
  )
);
</code></pre><h3 id="odk-to-salesforce-create-parent-record-with-many-children-from-parent-data">ODK to Salesforce: create parent record with many children from parent data</h3><p>Here, the user brings <code>time_end</code> and <code>parentId</code> onto the line items from the
parent object.</p><pre><code class="language-js">each(
  dataPath(&#x27;data[*]&#x27;),
  combine(
    create(
      &#x27;transaction__c&#x27;,
      fields(
        field(&#x27;Transaction_Date__c&#x27;, dataValue(&#x27;today&#x27;)),
        relationship(
          &#x27;Person_Responsible__r&#x27;,
          &#x27;Staff_ID_Code__c&#x27;,
          dataValue(&#x27;person_code&#x27;)
        ),
        field(&#x27;metainstanceid__c&#x27;, dataValue(&#x27;*meta-instance-id*&#x27;))
      )
    ),
    each(
      merge(
        dataPath(&#x27;line_items[*]&#x27;),
        fields(
          field(&#x27;end&#x27;, dataValue(&#x27;time_end&#x27;)),
          field(&#x27;parentId&#x27;, lastReferenceValue(&#x27;id&#x27;))
        )
      ),
      create(
        &#x27;line_item__c&#x27;,
        fields(
          field(&#x27;transaction__c&#x27;, dataValue(&#x27;parentId&#x27;)),
          field(&#x27;Barcode__c&#x27;, dataValue(&#x27;product_barcode&#x27;)),
          field(&#x27;ODK_Form_Completed__c&#x27;, dataValue(&#x27;end&#x27;))
        )
      )
    )
  )
);
</code></pre><blockquote><p><strong>NB - there was a known bug with the <code>combine</code> function which has been
resolved. <code>combine</code> can be used to combine two operations into one and is
commonly used to run multiple <code>create</code>&#x27;s inside an <code>each(path, operation)</code>.
The source code for combine can be found here:
<a href="https://github.com/OpenFn/language-common/blob/master/src/index.js#L204-L222">language-common: combine</a></strong></p></blockquote><h3 id="create-many-child-records-without-a-repeat-group-in-odk">Create many child records WITHOUT a repeat group in ODK</h3><pre><code class="language-js">beta.each(
  &#x27;$.data.data[*]&#x27;,
  upsert(
    &#x27;Outlet__c&#x27;,
    &#x27;Outlet_Code__c&#x27;,
    fields(
      field(&#x27;Outlet_Code__c&#x27;, dataValue(&#x27;outlet_code&#x27;)),
      field(&#x27;Location__Latitude__s&#x27;, dataValue(&#x27;gps:Latitude&#x27;)),
      field(&#x27;Location__Longitude__s&#x27;, dataValue(&#x27;gps:Longitude&#x27;))
    )
  )
),
  beta.each(
    &#x27;$.data.data[*]&#x27;,
    upsert(
      &#x27;Outlet_Call__c&#x27;,
      &#x27;Invoice_Number__c&#x27;,
      fields(
        field(&#x27;Invoice_Number__c&#x27;, dataValue(&#x27;invoice_number&#x27;)),
        relationship(&#x27;Outlet__r&#x27;, &#x27;Outlet_Code__c&#x27;, dataValue(&#x27;outlet_code&#x27;)),
        relationship(&#x27;RecordType&#x27;, &#x27;name&#x27;, &#x27;No Call Card&#x27;),
        field(&#x27;Trip__c&#x27;, &#x27;a0FN0000008jPue&#x27;),
        relationship(
          &#x27;Sales_Person__r&#x27;,
          &#x27;Sales_Rep_Code__c&#x27;,
          dataValue(&#x27;sales_rep_code&#x27;)
        ),
        field(&#x27;Date__c&#x27;, dataValue(&#x27;date&#x27;)),
        field(&#x27;Comments__c&#x27;, dataValue(&#x27;comments&#x27;))
      )
    )
  );
</code></pre><h3 id="salesforce-perform-an-update">Salesforce: perform an update</h3><pre><code class="language-js">update(&quot;Patient__c&quot;, fields(
  field(&quot;Id&quot;, dataValue(&quot;pathToSalesforceId&quot;)),
  field(&quot;Name__c&quot;, dataValue(&quot;patient.first_name&quot;)),
  field(...)
));
</code></pre><h3 id="salesforce-set-record-type-using-relationship">Salesforce: Set record type using &#x27;relationship(...)&#x27;</h3><pre><code class="language-js">create(
  &#x27;custom_obj__c&#x27;,
  fields(
    relationship(
      &#x27;RecordType&#x27;,
      &#x27;name&#x27;,
      dataValue(&#x27;submission_type&#x27;),
      field(&#x27;name&#x27;, dataValue(&#x27;Name&#x27;))
    )
  )
);
</code></pre><h3 id="salesforce-set-record-type-using-record-type-id">Salesforce: Set record type using record Type ID</h3><pre><code class="language-js">each(
  &#x27;$.data.data[*]&#x27;,
  create(
    &#x27;fancy_object__c&#x27;,
    fields(
      field(&#x27;RecordTypeId&#x27;, &#x27;012110000008s19&#x27;),
      field(&#x27;site_size&#x27;, dataValue(&#x27;size&#x27;))
    )
  )
);
</code></pre><h3 id="telerivet-send-sms-based-on-salesforce-workflow-alert">Telerivet: Send SMS based on Salesforce workflow alert</h3><pre><code class="language-js">send(
  fields(
    field(
      &#x27;to_number&#x27;,
      dataValue(
        &#x27;Envelope.Body.notifications.Notification.sObject.phone_number__c&#x27;
      )
    ),
    field(&#x27;message_type&#x27;, &#x27;sms&#x27;),
    field(&#x27;route_id&#x27;, &#x27;&#x27;),
    field(&#x27;content&#x27;, function (state) {
      return &#x27;Hey there. Your name is &#x27;.concat(
        dataValue(&#x27;Envelope.Body.notifications.Notification.sObject.name__c&#x27;)(
          state
        ),
        &#x27;.&#x27;
      );
    })
  )
);
</code></pre><h3 id="http-fetch-but-dont-fail">HTTP: fetch but don&#x27;t fail!</h3><pre><code class="language-js">// =============
// We use &quot;fetchWithErrors(...)&quot; so that when the
// SMS gateway returns an error the run does not &quot;fail&quot;.
// It &quot;succeeds&quot; and then delivers that error message
// back to Salesforce with the &quot;Update SMS Status&quot; job.
// =============
fetchWithErrors({
  getEndpoint: &#x27;send_to_contact&#x27;,
  query: function (state) {
    return {
      msisdn:
        state.data.Envelope.Body.notifications.Notification.sObject
          .SMS__Phone_Number__c,
      message:
        state.data.Envelope.Body.notifications.Notification.sObject
          .SMS__Message__c,
      api_key: &#x27;some-secret-key&#x27;,
    };
  },
  externalId: state.data.Envelope.Body.notifications.Notification.sObject.Id,
  postUrl: &#x27;https://www.openfn.org/inbox/another-secret-key&#x27;,
});
</code></pre><h3 id="sample-dhis2-events-api-job">Sample DHIS2 events API job:</h3><pre><code class="language-js">event(
  fields(
    field(&#x27;program&#x27;, &#x27;eBAyeGv0exc&#x27;),
    field(&#x27;orgUnit&#x27;, &#x27;DiszpKrYNg8&#x27;),
    field(&#x27;eventDate&#x27;, dataValue(&#x27;properties.date&#x27;)),
    field(&#x27;status&#x27;, &#x27;COMPLETED&#x27;),
    field(&#x27;storedBy&#x27;, &#x27;admin&#x27;),
    field(&#x27;coordinate&#x27;, {
      latitude: &#x27;59.8&#x27;,
      longitude: &#x27;10.9&#x27;,
    }),
    field(&#x27;dataValues&#x27;, function (state) {
      return [
        {
          dataElement: &#x27;qrur9Dvnyt5&#x27;,
          value: dataValue(&#x27;properties.prop_a&#x27;)(state),
        },
        {
          dataElement: &#x27;oZg33kd9taw&#x27;,
          value: dataValue(&#x27;properties.prop_b&#x27;)(state),
        },
        {
          dataElement: &#x27;msodh3rEMJa&#x27;,
          value: dataValue(&#x27;properties.prop_c&#x27;)(state),
        },
      ];
    })
  )
);
</code></pre><h3 id="sample-dhis2-data-value-sets-api-job">Sample DHIS2 data value sets API job:</h3><pre><code class="language-js">dataValueSet(
  fields(
    field(&#x27;dataSet&#x27;, &#x27;pBOMPrpg1QX&#x27;),
    field(&#x27;orgUnit&#x27;, &#x27;DiszpKrYNg8&#x27;),
    field(&#x27;period&#x27;, &#x27;201401&#x27;),
    field(&#x27;completeData&#x27;, dataValue(&#x27;date&#x27;)),
    field(&#x27;dataValues&#x27;, function (state) {
      return [
        { dataElement: &#x27;f7n9E0hX8qk&#x27;, value: dataValue(&#x27;prop_a&#x27;)(state) },
        { dataElement: &#x27;Ix2HsbDMLea&#x27;, value: dataValue(&#x27;prop_b&#x27;)(state) },
        { dataElement: &#x27;eY5ehpbEsB7&#x27;, value: dataValue(&#x27;prop_c&#x27;)(state) },
      ];
    })
  )
);
</code></pre><h3 id="sample-openmrs-expression-creates-a-person-and-then-a-patient">sample openMRS expression, creates a person and then a patient</h3><pre><code class="language-js">person(
  fields(
    field(&#x27;gender&#x27;, &#x27;F&#x27;),
    field(&#x27;names&#x27;, function (state) {
      return [
        {
          givenName: dataValue(&#x27;form.first_name&#x27;)(state),
          familyName: dataValue(&#x27;form.last_name&#x27;)(state),
        },
      ];
    })
  )
),
  patient(
    fields(
      field(&#x27;person&#x27;, lastReferenceValue(&#x27;uuid&#x27;)),
      field(&#x27;identifiers&#x27;, function (state) {
        return [
          {
            identifier: &#x27;1234&#x27;,
            identifierType: &#x27;8d79403a-c2cc-11de-8d13-0010c6dffd0f&#x27;,
            location: &#x27;8d6c993e-c2cc-11de-8d13-0010c6dffd0f&#x27;,
            preferred: true,
          },
        ];
      })
    )
  );
</code></pre><h3 id="merge-many-values-into-a-child-path">merge many values into a child path</h3><pre><code class="language-js">each(
  merge(
    dataPath(&quot;CHILD_ARRAY[*]&quot;),
    fields(
      field(&quot;metaId&quot;, dataValue(&quot;*meta-instance-id*&quot;)),
      field(&quot;parentId&quot;, lastReferenceValue(&quot;id&quot;))
    )
  ),
  create(...)
)
</code></pre><h3 id="arraytostring">arrayToString</h3><pre><code class="language-js">arrayToString(arr, separator_string);
</code></pre><h3 id="access-an-image-url-from-an-odk-submission">access an image URL from an ODK submission</h3><pre><code class="language-js">// In ODK the image URL is inside an image object...
field(&quot;Photo_URL_text__c&quot;, dataValue(&quot;image.url&quot;)),
</code></pre><h3 id="alterstate-alter-state-to-make-sure-data-is-in-an-array">alterState (alter state) to make sure data is in an array</h3><pre><code class="language-js">// Here, we make sure CommCare gives us an array to use in each(merge(...), ...)
alterState(state =&gt; {
  const idCards = state.data.form.ID_cards_given_to_vendor;
  if (!Array.isArray(idCards)) {
    state.data.form.ID_cards_given_to_vendor = [idCards];
  }
  return state;
});

// Now state has been changed, and we carry on...
each(
  merge(
    dataPath(&#x27;form.ID_cards_given_to_vendor[*]&#x27;),
    fields(
      field(&#x27;Vendor_Id&#x27;, dataValue(&#x27;form.ID_vendor&#x27;)),
      field(&#x27;form_finished_time&#x27;, dataValue(&#x27;form.meta.timeEnd&#x27;))
    )
  ),
  upsert(
    &#x27;Small_Packet__c&#x27;,
    &#x27;sp_id__c&#x27;,
    fields(
      field(&#x27;sp_id__c&#x27;, dataValue(&#x27;ID_cards_given_to_vendor&#x27;)),
      relationship(&#x27;Vendor__r&#x27;, &#x27;Badge_Code__c&#x27;, dataValue(&#x27;Vendor_Id&#x27;)),
      field(
        &#x27;Small_Packet_Distribution_Date__c&#x27;,
        dataValue(&#x27;form_finished_time&#x27;)
      )
    )
  )
);
</code></pre><h3 id="login-in-to-a-server-with-a-custom-ssl-certificate">Login in to a server with a custom SSL Certificate</h3><p>This snippet describes how you would connect to a secure server ignoring SSL
certificate verification. Set <code>strictSSL: false</code> in the options argument of the
<code>post</code> function in <code>language-http</code>.</p><pre><code class="language-js">post(
  `${state.configuration.url}/${path}`,
  {
    headers: { &#x27;content-type&#x27;: &#x27;application/json&#x27; },
    body: {
      email: &#x27;Luka&#x27;,
      password: &#x27;somethingSecret&#x27;,
    },
    strictSSL: false,
  },
  callback
);
</code></pre><h2 id="anonymous-functions">Anonymous Functions</h2><p>Different to <a href="/documentation/platform#named-functions">Named Functions</a>, Anonymous
functions are generic pieces of javascript which you can write to suit your
needs. Here are some examples of these custom functions:</p><h3 id="custom-replacer">Custom replacer</h3><pre><code class="language-js">field(&#x27;destination__c&#x27;, state =&gt; {
  console.log(something);
  return dataValue(&#x27;path_to_data&#x27;)(state).toString().replace(&#x27;cats&#x27;, &#x27;dogs&#x27;);
});
</code></pre><p>This will replace all &quot;cats&quot; with &quot;dogs&quot; in the string that lives at
<code>path_to_data</code>.</p><blockquote><p><strong>NOTE:</strong> The JavaScript <code>replace()</code> function only replaces the first instance
of whatever argument you specify. If you&#x27;re looking for a way to replace all
instances, we suggest you use a regex like we did in the
<a href="#custom-concatenation-of-null-values">example</a> below.</p></blockquote><h3 id="custom-arraytostring">Custom arrayToString</h3><pre><code class="language-js">field(&quot;target_specie_list__c&quot;, function(state) {
  return Array.apply(
    null, sourceValue(&quot;$.data.target_specie_list&quot;)(state)
  ).join(&#x27;, &#x27;)
}),
</code></pre><p>It will take an array, and concatenate each item into a string with a &quot;, &quot;
separator.</p><h3 id="custom-concatenation">Custom concatenation</h3><pre><code class="language-js">field(&#x27;ODK_Key__c&#x27;, function (state) {
  return dataValue(&#x27;metaId&#x27;)(state).concat(&#x27;(&#x27;, dataValue(&#x27;index&#x27;)(state), &#x27;)&#x27;);
});
</code></pre><p>This will concatenate two values.</p><h3 id="concatenation-of-null-values">Concatenation of null values</h3><p>This will concatenate many values, even if one or more are null, writing them to
a field called Main_Office_City_c.</p><pre><code class="language-js">...
  field(&quot;Main_Office_City__c&quot;, function(state) {
    return arrayToString([
      dataValue(&quot;Main_Office_City_a&quot;)(state) === null ? &quot;&quot; : dataValue(&quot;Main_Office_City_a&quot;)(state).toString().replace(/-/g, &quot; &quot;),
      dataValue(&quot;Main_Office_City_b&quot;)(state) === null ? &quot;&quot; : dataValue(&quot;Main_Office_City_b&quot;)(state).toString().replace(/-/g, &quot; &quot;),
      dataValue(&quot;Main_Office_City_c&quot;)(state) === null ? &quot;&quot; : dataValue(&quot;Main_Office_City_c&quot;)(state).toString().replace(/-/g, &quot; &quot;),
      dataValue(&quot;Main_Office_City_d&quot;)(state) === null ? &quot;&quot; : dataValue(&quot;Main_Office_City_d&quot;)(state).toString().replace(/-/g, &quot; &quot;),
    ].filter(Boolean), &#x27;,&#x27;)
  })
</code></pre><blockquote><p>Notice how this custom function makes use of the <strong>regex</strong> <code>/-/g</code> to ensure
that all instances are accounted for (g = global search).</p></blockquote><h3 id="custom-nth-reference-id">Custom Nth reference ID</h3><p>If you ever want to retrieve the FIRST object you created, or the SECOND, or the
Nth, for that matter, a function like this will do the trick.</p><pre><code class="language-js">field(&#x27;parent__c&#x27;, function (state) {
  return state.references[state.references.length - 1].id;
});
</code></pre><p>See how instead of taking the id of the &quot;last&quot; thing that was created in
Salesforce, you&#x27;re taking the id of the 1st thing, or 2nd thing if you replace
&quot;length-1&quot; with &quot;length-2&quot;.</p><h3 id="convert-date-string-to-standard-iso-date-for-salesforce">Convert date string to standard ISO date for Salesforce</h3><pre><code class="language-js">field(&#x27;Payment_Date__c&#x27;, function (state) {
  return new Date(dataValue(&#x27;payment_date&#x27;)(state)).toISOString();
});
</code></pre><blockquote><p><strong>NOTE</strong>: The output of this function will always be formatted according to
GMT time-zone.</p></blockquote><h3 id="use-external-id-fields-for-relationships-during-a-bulk-load-in-salesforce">Use external ID fields for relationships during a bulk load in Salesforce</h3><pre><code class="language-js">array.map(item =&gt; {
  return {
    Patient_Name__c: item.fullName,
    &#x27;Clinic__r.Unique_Clinic_Identifier__c&#x27;: item.clinicId,
    &#x27;RecordType.Name&#x27;: item.type,
  };
});
</code></pre><h3 id="bulk-upsert-with-an-external-id-in-salesforce">Bulk upsert with an external ID in salesforce</h3><pre><code class="language-js">bulk(
  &#x27;Visit_new__c&#x27;,
  &#x27;upsert&#x27;,
  {
    extIdField: &#x27;commcare_case_id__c&#x27;,
    failOnError: true,
    allowNoOp: true,
  },
  dataValue(&#x27;patients&#x27;)
);
</code></pre></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/openfn/docs/edit/main/docs/appendix.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/documentation/trouble-shooting"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Troubleshooting</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/documentation/release-notes"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Release Notes Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#filters" class="table-of-contents__link">Filters</a><ul><li><a href="#match-messages-where-the-formid-is-robot_photo_21042015" class="table-of-contents__link">Match messages <code>WHERE</code> the <code>formId</code> is <code>&quot;Robot_Photo_21.04.2015&quot;</code></a></li><li><a href="#match-a-message-where-this-and-that-are-both-included" class="table-of-contents__link">Match a message <code>WHERE</code> this <code>AND</code> that are both included</a></li><li><a href="#match-a-message-with-two-fragments-inside-an-array-called-data" class="table-of-contents__link">Match a message with two fragments inside an array called <code>data</code></a></li><li><a href="#match-a-message-with-a-fragment-inside-another-object-called-form" class="table-of-contents__link">Match a message with a fragment inside another object called <code>form</code></a></li></ul></li><li><a href="#job-expressions" class="table-of-contents__link">Job Expressions</a><ul><li><a href="#job-expression-for-commcare-to-sf" class="table-of-contents__link">Job expression (for CommCare to SF)</a></li><li><a href="#accessing-the-data-array-in-open-data-kit-submissions" class="table-of-contents__link">Accessing the &quot;data array&quot; in Open Data Kit submissions</a></li><li><a href="#odk-to-salesforce-create-parent-record-with-many-children-from-parent-data" class="table-of-contents__link">ODK to Salesforce: create parent record with many children from parent data</a></li><li><a href="#create-many-child-records-without-a-repeat-group-in-odk" class="table-of-contents__link">Create many child records WITHOUT a repeat group in ODK</a></li><li><a href="#salesforce-perform-an-update" class="table-of-contents__link">Salesforce: perform an update</a></li><li><a href="#salesforce-set-record-type-using-relationship" class="table-of-contents__link">Salesforce: Set record type using &#39;relationship(...)&#39;</a></li><li><a href="#salesforce-set-record-type-using-record-type-id" class="table-of-contents__link">Salesforce: Set record type using record Type ID</a></li><li><a href="#telerivet-send-sms-based-on-salesforce-workflow-alert" class="table-of-contents__link">Telerivet: Send SMS based on Salesforce workflow alert</a></li><li><a href="#http-fetch-but-dont-fail" class="table-of-contents__link">HTTP: fetch but don&#39;t fail!</a></li><li><a href="#sample-dhis2-events-api-job" class="table-of-contents__link">Sample DHIS2 events API job:</a></li><li><a href="#sample-dhis2-data-value-sets-api-job" class="table-of-contents__link">Sample DHIS2 data value sets API job:</a></li><li><a href="#sample-openmrs-expression-creates-a-person-and-then-a-patient" class="table-of-contents__link">sample openMRS expression, creates a person and then a patient</a></li><li><a href="#merge-many-values-into-a-child-path" class="table-of-contents__link">merge many values into a child path</a></li><li><a href="#arraytostring" class="table-of-contents__link">arrayToString</a></li><li><a href="#access-an-image-url-from-an-odk-submission" class="table-of-contents__link">access an image URL from an ODK submission</a></li><li><a href="#alterstate-alter-state-to-make-sure-data-is-in-an-array" class="table-of-contents__link">alterState (alter state) to make sure data is in an array</a></li><li><a href="#login-in-to-a-server-with-a-custom-ssl-certificate" class="table-of-contents__link">Login in to a server with a custom SSL Certificate</a></li></ul></li><li><a href="#anonymous-functions" class="table-of-contents__link">Anonymous Functions</a><ul><li><a href="#custom-replacer" class="table-of-contents__link">Custom replacer</a></li><li><a href="#custom-arraytostring" class="table-of-contents__link">Custom arrayToString</a></li><li><a href="#custom-concatenation" class="table-of-contents__link">Custom concatenation</a></li><li><a href="#concatenation-of-null-values" class="table-of-contents__link">Concatenation of null values</a></li><li><a href="#custom-nth-reference-id" class="table-of-contents__link">Custom Nth reference ID</a></li><li><a href="#convert-date-string-to-standard-iso-date-for-salesforce" class="table-of-contents__link">Convert date string to standard ISO date for Salesforce</a></li><li><a href="#use-external-id-fields-for-relationships-during-a-bulk-load-in-salesforce" class="table-of-contents__link">Use external ID fields for relationships during a bulk load in Salesforce</a></li><li><a href="#bulk-upsert-with-an-external-id-in-salesforce" class="table-of-contents__link">Bulk upsert with an external ID in salesforce</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">This Site</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/documentation">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/library">Library</a></li><li class="footer__item"><a class="footer__link-item" href="/articles">Articles</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://community.openfn.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum</a></li><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/openfn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://twitter.com/openfn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.openfn.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">OpenFn.org</a></li><li class="footer__item"><a href="https://github.com/openfn" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github</a></li><li class="footer__item"><a href="https://blog.openfn.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Open Function Group LLC</div></div></div></footer></div>
<script src="/styles.0cd493b1.js"></script>
<script src="/runtime~main.995dbd0d.js"></script>
<script src="/main.1ef3c80f.js"></script>
<script src="/1.5843ccaf.js"></script>
<script src="/2.fd2ee5c5.js"></script>
<script src="/01a85c17.a7feb7ed.js"></script>
<script src="/1be78505.2552ac6d.js"></script>
<script src="/6875c492.f6c16a7d.js"></script>
<script src="/a6aa9e1f.c0f6bc6b.js"></script>
<script src="/c4f5d8e4.cbd158d4.js"></script>
<script src="/ccc49370.e4d7dd25.js"></script>
<script src="/78.474ff80a.js"></script>
<script src="/77.c7ff769e.js"></script>
<script src="/935f2afb.1e7c041b.js"></script>
<script src="/17896441.f9ac7cb1.js"></script>
<script src="/cddf45a4.a57beaf6.js"></script>
</body>
</html>