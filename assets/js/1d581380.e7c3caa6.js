(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{108:function(e,a,t){"use strict";t.r(a),t.d(a,"frontMatter",(function(){return i})),t.d(a,"metadata",(function(){return s})),t.d(a,"toc",(function(){return d})),t.d(a,"default",(function(){return _}));var n=t(3),r=t(8),o=(t(0),t(331)),i={title:"MOH 513 Update Household Revised (NEW) with salesforce",sidebar_label:"MOH 513 Update Household Revised (NEW)",id:"MOH 513 Update Household Revised NEW-2020-02-27",keywords:["library","job","expression","salesforce","alterState","dataPath","dataValue","each","field","fields","merge","upsert","upsertIf"]},s={unversionedId:"jobs/auto/MOH 513 Update Household Revised NEW-2020-02-27",id:"jobs/auto/MOH 513 Update Household Revised NEW-2020-02-27",isDocsHomePage:!1,title:"MOH 513 Update Household Revised (NEW) with salesforce",description:"This job was provided by an OpenFn.org user via the job library API.",source:"@site/library/jobs/auto/MOH 513 Update Household Revised NEW-2020-02-27.md",sourceDirName:"jobs/auto",slug:"/jobs/auto/MOH 513 Update Household Revised NEW-2020-02-27",permalink:"/library/jobs/auto/MOH 513 Update Household Revised NEW-2020-02-27",version:"current",sidebar_label:"MOH 513 Update Household Revised (NEW)",frontMatter:{title:"MOH 513 Update Household Revised (NEW) with salesforce",sidebar_label:"MOH 513 Update Household Revised (NEW)",id:"MOH 513 Update Household Revised NEW-2020-02-27",keywords:["library","job","expression","salesforce","alterState","dataPath","dataValue","each","field","fields","merge","upsert","upsertIf"]},sidebar:"library",previous:{title:"Input Seed Support and Kitchen Garden Adoption with salesforce",permalink:"/library/jobs/auto/Input Seed Support and Kitchen Garden Adoption-2017-07-27"},next:{title:"Nutrition Survey Submissions with salesforce",permalink:"/library/jobs/auto/Nutrition Survey Submissions-2017-08-31"}},d=[{value:"Metadata",id:"metadata",children:[]},{value:"Key Functions",id:"key-functions",children:[]},{value:"Expression",id:"expression",children:[]}],l={toc:d};function _(e){var a=e.components,t=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(n.a)({},l,t,{components:a,mdxType:"MDXLayout"}),Object(o.b)("em",null,"This job was provided by an OpenFn.org user via the job library API."),Object(o.b)("h2",{id:"metadata"},"Metadata"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Name: MOH 513 Update Household Revised (NEW)"),Object(o.b)("li",{parentName:"ul"},"Adaptor: ",Object(o.b)("inlineCode",{parentName:"li"},"@openfn/language-salesforce")),Object(o.b)("li",{parentName:"ul"},"Adaptor Version: ",Object(o.b)("inlineCode",{parentName:"li"},"v1.3.2")),Object(o.b)("li",{parentName:"ul"},"Created about 1 year ago"),Object(o.b)("li",{parentName:"ul"},"Updated 13 days ago")),Object(o.b)("h2",{id:"key-functions"},"Key Functions"),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"alterState"),", ",Object(o.b)("inlineCode",{parentName:"p"},"dataPath"),", ",Object(o.b)("inlineCode",{parentName:"p"},"dataValue"),", ",Object(o.b)("inlineCode",{parentName:"p"},"each"),", ",Object(o.b)("inlineCode",{parentName:"p"},"field"),", ",Object(o.b)("inlineCode",{parentName:"p"},"fields"),", ",Object(o.b)("inlineCode",{parentName:"p"},"merge"),", ",Object(o.b)("inlineCode",{parentName:"p"},"upsert"),", ",Object(o.b)("inlineCode",{parentName:"p"},"upsertIf")),Object(o.b)("h2",{id:"expression"},"Expression"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-js"},"// REVISED Form - To replace old Update HH\nalterState(state => {\n  const deaths = state.data.form.household_deaths ? state.data.form.household_deaths.deaths : '';\n  if (deaths !== '' && !Array.isArray(deaths)) {\n    state.data.form.household_deaths.deaths = [deaths];\n  }\n\n  const supervisorMap = {\n    community_health_nurse: 'Community Health Nurse',\n    chw_supervisor: 'CHW Supervisor',\n    chewschas: 'CHEWs/CHAs',\n    other: 'Other',\n    none: 'None',\n  };\n\n  return { ...state, supervisorMap };\n});\nupsert(\n  'Household__c',\n  'CommCare_Code__c',\n  fields(\n    field('CommCare_Code__c', dataValue('form.case.@case_id')),\n    field('MOH_household_code__c', state => {\n      var moh = dataValue('form.Household_Information.moh_code')(state);\n      var mohLinked = dataValue('form.MOH_household_code_linked')(state);\n      return moh ? moh : mohLinked && mohLinked !== \"\" ? mohLinked : undefined;\n    }),\n    field('Active_Household__c', state => {\n      var status = dataValue('form.Household_Status')(state);\n      return status && status === 'No' ? false : status === 'Yes' ? true : status;\n    }),\n    field('Inactive_Reason__c', state => {\n      var reason = dataValue('form.Reason_for_Inactive')(state);\n      return reason ? reason.toString().replace(/_/g, ' ') : null;\n    }),\n    field('Source__c', 1),\n    field('Completed_COVID_19_Phone_Screening__c', dataValue('form.did_you_complete_the_covid-19_phone_screening_for_this_household')),\n    field('Household_Visit_Type__c', state => {\n      var visit = dataValue('form.is_this_a_physical_home_visit_or_a_phone_call_visit')(state);\n      return visit ? visit.toString().replace(/_/g, ' ') : null;\n    }),\n    field('Household_village__c', dataValue('form.village')),\n    field(\n      'Access_to_safe_water__c',\n      dataValue('form.Household_Information.Safe_Water')\n    ),\n    field(\n      'Treats_Drinking_Water__c',\n      dataValue('form.Household_Information.Treats_Drinking_Water')\n    ),\n    field(\n      'Tippy_Tap__c',\n      dataValue('form.Household_Information.Active_Handwashing_Station')\n    ),\n    field(\n      'Pit_Latrine__c',\n      dataValue('form.Household_Information.Functional_Latrine')\n    ),\n    field(\n      'Rubbish_Pit__c',\n      dataValue('form.Household_Information.Rubbish_Pit')\n    ),\n    field(\n      'Drying_Rack__c',\n      dataValue('form.Household_Information.Drying_Rack')\n    ),\n    field(\n      'Kitchen_Garden__c',\n      dataValue('form.Household_Information.Kitchen_Garden')\n    ),\n    field(\n      'Cookstove__c',\n      dataValue('form.Household_Information.Improved_Cooking_Method')\n    ),\n    field('Clothe__c', dataValue('form.Household_Information.Clothesline')),\n    field(\n      'WASH_Trained__c',\n      dataValue('form.Household_Information.WASH_Trained')\n    ),\n    field('Uses_ITNs__c', dataValue('form.Household_Information.ITNs')),\n    //field(\"Family_planning__c\", dataValue(\"form.Household_Information.family_planning\")), // new mapping\n    //field(\"Family_planning_method__c\", dataValue(\"form.Household_Information.Family_planning_method\")), // new mapping\n    field('Deaths_in_the_last_6_months__c', state => {\n      var deaths = dataValue('form.household_deaths.deaths_in_past_6_months')(\n        state\n      );\n      return deaths && deaths > 0 ? 'Yes' : 'No';\n    }),\n    field(\n      'Total_household_people__c',\n      dataValue('form.Total_Number_of_Members')\n    ),\n    field('Supervisor_Visit__c', state =>\n      state.data.form.supervisor_visit\n        ? state.supervisorMap[state.data.form.supervisor_visit]\n        : null\n    ),\n    field(\"Health_insurance__c\",\n      dataValue(\"form.health_insurace_cover\")),\n    field(\n      \"Health_insurance_active_status__c\",\n      dataValue(\"form.healthinsurance_active\")\n    ),\n    field(\"Health_insurance_type__c\", (state) => {\n      var status = dataValue(\"form.health_insurance\")(state);\n      return status && status === 'other_please_specify_if_active' ? 'Other' :\n        status === 'nhif' ? 'NHIF' : status === 'Linda_mama' || 'linda_mama' ? 'Linda mama' : status;\n    }),\n    field(\"Other_Health_Insurance__c\", dataValue(\"form.if_other_please_specify\"))\n  )\n),\n  upsert(\n    'Visit__c',\n    'CommCare_Visit_ID__c',\n    fields(\n      field('CommCare_Visit_ID__c', dataValue('id')),\n      relationship(\n        'Household__r',\n        'CommCare_Code__c',\n        dataValue('form.case.@case_id')\n      ),\n      field('Visit_UID__c', state => {\n        var hh = dataValue('form.case.@case_id')(state);\n        var date = dataValue('form.Date')(state);\n        return hh + date;\n      }),\n      field('Date__c', dataValue('form.Date')),\n      //field(\"Household_CHW__c\", \"a031x000002S9lm\"), //Hardcoded for sandbox testing\n      field('Household_CHW__c', dataValue('form.chw')),\n      field('Name', 'CHW Visit'),\n      field('Supervisor_Visit__c', state =>\n        state.data.form.supervisor_visit\n          ? state.supervisorMap[state.data.form.supervisor_visit]\n          : null\n      )\n    )\n  ),\n  //New logic to insert child Person records if person is marked as deceased in HH form\n  each(\n    merge(\n      dataPath('$.form.household_deaths.deaths[*]'),\n      fields(\n        field('caseId', dataValue('form.case.@case_id')),\n        field('catchment', dataValue('form.catchment')),\n        field('Date', dataValue('form.Date')),\n      )\n    ),\n    upsertIf(\n      state.data.form.household_deaths && state.data.form.household_deaths.deaths_in_past_6_months > 0, //only insert deceased Person if deaths\n      'Person__c',\n      'CommCare_ID__c',\n      fields(\n        field('CommCare_ID__c', state => {\n          var age = dataValue('age_dead')(state);\n          return `${state.data.caseId}${age}`;\n        }),\n        field('CommCare_HH_Code__c', dataValue('caseId')),\n        relationship('RecordType', 'Name', state => {\n          var age = dataValue('age_dead')(state);\n          var gender = dataValue('gender_dead')(state);\n          var rt = '';\n          if (age < 5) {\n            rt = 'Child';\n          } else if (age < 18) {\n            rt = 'Youth';\n          } else if (gender === 'female') {\n            rt = 'Female Adult';\n          } else {\n            rt = 'Male Adult';\n          }\n          return rt;\n        }),\n        field('Name', 'Deceased Person'),\n        field('Source__c', true),\n        relationship('Catchment__r', 'Name', dataValue('catchment')),\n        field('Client_Status__c', 'Deceased'),\n        field('Dead_age__c', dataValue('age_dead')),\n        field('Cause_of_Death__c', state => {\n          var cause = dataValue('cause_of_death_dead')(state);\n          return cause !== undefined\n            ? cause.toString().replace(/_/g, ' ')\n            : null;\n        }),\n        field('Verbal_autopsy__c', dataValue('verbal_autopsy')),\n        field('Client_Status__c', 'Deceased'),\n        field('Active_in_Thrive_Thru_5__c', 'No'),\n        field('Active_in_HAWI__c', 'No'),\n        field('Active_TT5_Mother__c', 'No'),\n        field('TT5_Mother_Registrant__c', 'No'),\n        field('Date_of_Death__c', dataValue('Date')),\n        field('Inactive_Date__c', dataValue('Date'))\n      )\n    )\n  );\n//== TODO: Confirm no Active Person records registered via this HH form ******//\n")))}_.isMDXComponent=!0},331:function(e,a,t){"use strict";t.d(a,"a",(function(){return u})),t.d(a,"b",(function(){return m}));var n=t(0),r=t.n(n);function o(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function i(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function s(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?i(Object(t),!0).forEach((function(a){o(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function d(e,a){if(null==e)return{};var t,n,r=function(e,a){if(null==e)return{};var t,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)t=o[n],a.indexOf(t)>=0||(r[t]=e[t]);return r}(e,a);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)t=o[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=r.a.createContext({}),_=function(e){var a=r.a.useContext(l),t=a;return e&&(t="function"==typeof e?e(a):s(s({},a),e)),t},u=function(e){var a=_(e.components);return r.a.createElement(l.Provider,{value:a},e.children)},c={inlineCode:"code",wrapper:function(e){var a=e.children;return r.a.createElement(r.a.Fragment,{},a)}},f=r.a.forwardRef((function(e,a){var t=e.components,n=e.mdxType,o=e.originalType,i=e.parentName,l=d(e,["components","mdxType","originalType","parentName"]),u=_(t),f=n,m=u["".concat(i,".").concat(f)]||u[f]||c[f]||o;return t?r.a.createElement(m,s(s({ref:a},l),{},{components:t})):r.a.createElement(m,s({ref:a},l))}));function m(e,a){var t=arguments,n=a&&a.mdxType;if("string"==typeof e||n){var o=t.length,i=new Array(o);i[0]=f;var s={};for(var d in a)hasOwnProperty.call(a,d)&&(s[d]=a[d]);s.originalType=e,s.mdxType="string"==typeof e?e:n,i[1]=s;for(var l=2;l<o;l++)i[l]=t[l];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,t)}f.displayName="MDXCreateElement"}}]);